<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Insert title here</title>
<link rel="stylesheet" href="../css/bootstrap.min.css">
<link rel="stylesheet" href="../css/jquery.fullPage.css">
<style type="text/css">
.del-blank {
	margin-left : -15px;
	padding-right : -15px;
}
</style>
</head>
<body>
	<div id="fullPageContainer">
		<div class="section container">
			<div class="row">
				<div class="col-xs-6">
					<h1>15:43<br><small>周三 11月10日</small></h1>
				</div>
				<div class="col-xs-6">
					<h1 class="text-center">6℃</h1>
				</div>
			</div>
		</div>
		<div class="section container">
			<div class="row">
				<div class="col-xs-12">
					<div id="dailyTemperChart" style="height: 300px;"></div>
				</div>
			</div>
			<br>
			<div class="row">
				<div class="col-xs-4" style="background-color: #F8F8FF">
					<h3 class="text-center">
						<small><span id="condMsg"></span></small><img src="" class="img-responsive center-block" style="width: 75px" id="condCode">
					</h3>
					<h3 class="text-center">
						<small>降水量</small><br><span id="pcpn"></span>mm</h3>
				</div>
				<div class="col-xs-8">
					<div id="windChart" style="height: 200px;"></div>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-4" style="background-color: #FCFCFC">
					<h3 class="text-center">
						<small>湿度</small><br><span id="humidity"></span>%</h3>
					<br>
				</div>
				<div class="col-xs-4" style="background-color: #FAFAFA">
					<h3 class="text-center">
						<small>可见度</small><br><span id="visibility"></span>km</h3>
					<br>
				</div>
				<div class="col-xs-4" style="background-color: #F8F8FF">
					<h3 class="text-center">
						<small>气压</small><br><span id="pressure"></span>mb</h3>
					<br>
				</div>
			</div>
		</div>
	</div>
	<script src="../js/util.js"></script>
	<script src="../js/jquery/jquery-1.11.1.js"></script>
	<script src="../js/jquery/jquery.fullPage.min.js"></script>
	<script src="../js/bootstrap/bootstrap.min.js"></script>
	<script src="../js/other/echarts.js"></script>
	<script type="text/javascript">
	function displayWindChart(index) {
		// echarts.js 路径配置
		require.config({
	        paths: {
	            echarts: '../js/other'
	        }
	    });
		// 使用echarts.js
		require(
			[
			    'echarts',
			    'echarts/chart/gauge'
			],
            function (ec) {
                var myChart = ec.init(document.getElementById('windChart'));
                /* myChart.showLoading({
                    text: '玩儿命加载中...'
                }); */
				var option = {
                		series : [
                		          {
                		              name:'个性化仪表盘',
                		              type:'gauge',
                		              center : ['50%', '50%'],
                		              radius : [0, '95%'],
                		              startAngle: 140,
                		              endAngle : -140,
                		              min: 0,
                		              max: 120,
                		              precision: 0,
                		              splitNumber: 10,
                		              axisLine: {
                		                  show: true,
                		                  lineStyle: {
                		                      color: [[0.2, 'lightgreen'],[0.6, 'skyblue'],[0.8, 'orange'],[1, '#ff4500']], 
                		                      width: 20
                		                  }
                		              },
                		              axisTick: {
                		                  show: true,
                		                  splitNumber: 5,
                		                  length :8,
                		                  lineStyle: {
                		                      color: '#eee',
                		                      width: 1,
                		                      type: 'solid'
                		                  }
                		              },
                		              axisLabel: {
                		                  show: true,
                		                  formatter: function(v){
                		                      switch (v+''){
                		                          case '12': return '弱';
                		                          case '48': return '低';
                		                          case '84': return '中';
                		                          case '108': return '高';
                		                          default: return '';
                		                      }
                		                  },
                		                  textStyle: {
                		                      color: '#333'
                		                  }
                		              },
                		              splitLine: {           // 分隔线
                		                  show: true,        // 默认显示，属性show控制显示与否
                		                  length :30,         // 属性length控制线长
                		                  lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                		                      color: '#eee',
                		                      width: 2,
                		                      type: 'solid'
                		                  }
                		              },
                		              pointer : {
                		                  length : '80%',
                		                  width : 8,
                		                  color : 'auto'
                		              },
                		              title : {
                		                  show : true,
                		                  offsetCenter: ['-65%', -10],
                		                  textStyle: {
                		                      color: '#333',
                		                      fontSize : 15
                		                  }
                		              },
                		              detail : {
                		                  show : true,
                		                  backgroundColor: 'rgba(0,0,0,0)',
                		                  borderWidth: 0,
                		                  borderColor: '#ccc',
                		                  width: 90,
                		                  height: 40,
                		                  offsetCenter: ['-60%', 0],
                		                  formatter:'{value}km/h',
                		                  textStyle: {
                		                      color: 'auto',
                		                      fontSize : 25
                		                  }
                		              },
                		              data:[{value: windArr[index].spd, name: windArr[index].sc}]
                		          }
						]
					}
					myChart.setOption(option);
				});
		}
	
	function displayDailyTemperChart() {
		// echarts.js 路径配置
		require.config({
	        paths: {
	            echarts: '../js/other'
	        }
	    });
		// 使用echarts.js
		require(
			[
			    'echarts',
			    'echarts/chart/line'
			    //'echarts/chart/bar'
			],
            function (ec) {
                var myChart = ec.init(document.getElementById('dailyTemperChart'));
                /* myChart.showLoading({
                    text: '玩儿命加载中...'
                }); */
				var option = {
						title : {
							text : '最近一个月气温变化',
							subtext : '测试数据',
							textStyle : {
								fontSize: 16,
							    fontWeight: 'bolder',
							    color: '#333'
							}
						},
						tooltip : {
							//formatter : '{b}<br>max : {c}°C<br>min : {c1}°C',
							formatter : function(params,ticket,callback) {
								//console.log(JSON.stringify(params));
								var res = params[0].name;
								for (var i = 0; i < params.length; i++) {
									res += '<br>' + params[i].seriesName + " : " + params[i].value + "℃";
								}
								setTimeout(function (){
									var index = getIndex(startDate, params[0].name);
									displayWeatherInfo(index);
					                // 仅为了模拟异步回调
					                callback(ticket, res);
					            }, 500)
								return "loading..."
							},
							trigger : 'axis'
						},
						legend : {
							data : [ '最高气温', '最低气温'],
							x : 'right'
						},
						xAxis : [ {
							type : 'category',
							boundaryGap : false,
							axisLabel : {
				                formatter: function(value) {
				                	var date = new Date(value);
				                	return (date.getMonth() + 1) + "/" + date.getDate();
				                	//return date.getFullYear() + "\n" + (date.getMonth() + 1) + "/" + date.getDate();
				                }
				            },
							/* scale : true, */
							data : dateArr
						} ],
						yAxis : [{
							show : true,
							type : 'value',
							name : '(°C)',
							axisLabel : {
				                formatter: '{value}'// °C'
				            }
						}],
						grid : {
							x : '25',
							y : '70',
							x2 : '20'
						},
						dataZoom: {
					        show: true,
					        start : 70,
					        handleSize : 15
					    },
						series : [
							{
								name:'最高气温',
						        type:'line',
						        smooth:true,
						        itemStyle: {normal: {lineStyle: {type: 'default'}}},
						        data: maxTemperArr
							},
						    {
								name:'最低气温',
								type:'line',
								smooth:true,
								itemStyle: {normal: {lineStyle: {type: 'default'}}},
								data: minTemperArr
							}
						]
					}
					myChart.setOption(option);
				});
		}
	
		function displayWeatherInfo(index) {
			var humidity = humidityArr[index];
			$("#humidity").html(humidity);
			
			var visibility = visibilityArr[index];
			$("#visibility").html(visibility);
			
			var pressure = pressureArr[index];
			$("#pressure").html(pressure);
			
			var pcpn = pcpnArr[index];
			$("#pcpn").html(pcpn);
			
			var condCode = condCodeArr[index];
			$("#condCode").attr("src", "../image/code/" + condCode + ".png");
			
			var condMsg = condMsgArr[index];
			$("#condMsg").html(condMsg);
			
			displayWindChart(index);
		}
	
		function main (resData) {
			dateArr = new Array();
			maxTemperArr = new Array();
			minTemperArr = new Array();
			humidityArr = new Array();
			visibilityArr = new Array();
			pressureArr = new Array();
			windArr = new Array();
			pcpnArr = new Array();
			condCodeArr = new Array();
			condMsgArr = new Array();
			
			startDate = resData[0].date;
			
			var today = getCurrentDate();
			// 根据echart.js 规则，将当天日期特殊标记
			var formatToday = {value: today, textStyle: {color: 'red', fontWeight: 'bolder', fontSize: '14'}};
			$(resData).each(function(index, element) {
				if (element.date == today) {
					dateArr[index] = formatToday;
				} else {
					dateArr[index] = element.date;
				}
				maxTemperArr[index] = element.tmp.max;
				minTemperArr[index] = element.tmp.min;
				humidityArr[index] = element.hum;
				visibilityArr[index] = element.vis;
				pressureArr[index] = element.pres;
				windArr[index] = element.wind;
				pcpnArr[index] = element.pcpn;
				condCodeArr[index] = element.cond.code_d;
				condMsgArr[index] = element.cond.txt_d;
			});
			
			var index = getIndex(startDate, today);
			displayWeatherInfo(index);
			
			displayDailyTemperChart();
		
		}
	
		$(function() {
			var isInit = false;
			$('#fullPageContainer').fullpage({
				sectionsColor: ['#FFFFFF', '#FFFFFF'],//#4A4A4A #E65600
				afterLoad: function(anchorLink, index){
					if(index == 2 && !isInit){
						var sendData = {"cityId" : "CN101010100", "beginDate" : "20151117", "days" : "30"};
						$.ajax({
							url : "../weather/queryHistoryInfo.do",
							method : "get",
							contentType : 'application/json;charset=UTF-8',
							dataType : 'json',
							data : sendData,
							success : function(resData, textStatus, jqXHR) {
								console.log(JSON.stringify(resData));
								
								main(resData);
								isInit = true;
							},
							error : function(XMLHttpRequest, textStatus, errorThrown) {
							}
						});
					}
				}
			});
		});
	</script>
</body>
</html>